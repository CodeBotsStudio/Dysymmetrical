name: Discord Commit Action

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  send_embed:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Commit List
        if: github.event_name == 'push'
        run: |
          echo "COMMIT_LIST<<EOF" >> $GITHUB_ENV
          
          for commit in $(jq -r '.commits[].id' "$GITHUB_EVENT_PATH"); do
            short=$(echo "$commit" | cut -c1-7)
            msg=$(git log -1 --pretty=%s "$commit")
            author=$(git log -1 --pretty=%an "$commit")
            url="https://github.com/${{ github.repository }}/commit/$commit"
          
            echo "[\`$short\`]($url) $msg - **$author**" >> $GITHUB_ENV
          
            files=$(git diff-tree --no-commit-id --name-status -r "$commit" | awk '
              {
                if ($1 ~ /^A/) print "Added: " $2
                else if ($1 ~ /^M/) print "Modified: " $2
                else if ($1 ~ /^D/) print "Removed: " $2
                else if ($1 ~ /^R/) print "Renamed: " $2 " â†’ " $3
              }
            ')
          
            if [ -n "$files" ]; then
              echo '```diff' >> $GITHUB_ENV
              echo "$files" >> $GITHUB_ENV
              echo '```' >> $GITHUB_ENV
            fi
          
            echo "" >> $GITHUB_ENV
          done
          
          echo "EOF" >> $GITHUB_ENV

      - uses: sarisia/actions-status-discord@v1.15.5
        with:
          webhook: ${{ secrets.WEBHOOK_URL }}
          url: "https://github.com/CodeBotsStudio/Dysymmetrical"
          title: "Dysymmetrical Activity Notification"
          
          description: |
            **Commit List**
            ${{ env.COMMIT_LIST }}

            **Branch**
            ${{ github.ref_name }}
            
          color: 0x999999
          nodetail: true